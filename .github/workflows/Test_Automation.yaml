name: Test Automation
on:
  pull_request:
    branches:
      - main
      - develop
  push:
    branches:
      - main
  workflow_dispatch:
  schedule:
    - cron: '0 */4 * * *' # ì‹¤í–‰ ì‹œê°„ ì„¤ì •(UTC)

concurrency:  # ë™ì‹œì— ì—¬ëŸ¬ ê°œì˜ ë°°í¬ ì‹¤í–‰ ë°©ì§€
  group: gh-pages-deploy
  cancel-in-progress: true

env:
  SAFE_BRANCH: ${{ github.ref_name }}
  BRANCH_NAME: ${{ github.ref_name }}

jobs:
  ui_tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set RUN_TS (timestamp)
        run: |
          echo "RUN_TS=$(TZ=Asia/Seoul date +'%Y%m%d_%H%M%S')" >> $GITHUB_ENV
          echo "BRANCH_NAME=${{ github.ref_name }}" >> $GITHUB_ENV

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install Dependencies
        run: |
          python -m venv venv
          venv/bin/python -m pip install -r requirements.txt allure-pytest

      - name: Install Allure CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y wget unzip
          wget https://github.com/allure-framework/allure2/releases/download/2.32.2/allure-2.32.2.tgz
          tar -zxvf allure-2.32.2.tgz
          sudo mv allure-2.32.2 /opt/allure
          sudo ln -s /opt/allure/bin/allure /usr/bin/allure
          allure --version

      - name: Set Test credentials
        run: |
          echo "KURLY_TEST_USER_EMAIL=${{ secrets.KURLY_TEST_USERNAME }}" >> $GITHUB_ENV
          echo "KURLY_TEST_USER_PASSWORD=${{ secrets.KURLY_TEST_PASSWORD }}" >> $GITHUB_ENV

      - name: Run UI Tests
        run: |
          rm -rf allure-results-ui || true
          mkdir -p allure-results-ui
          venv/bin/python -m pytest src/tests/ui \
            --alluredir=allure-results-ui \
            --junitxml=ui_report.xml \
            --capture=tee-sys -v \
            --maxfail=100 --disable-warnings --tb=short
        continue-on-error: true

      - name: Upload UI Allure Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-results-ui
          path: allure-results-ui
          retention-days: 7

      - name: Upload UI Test Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ui-test-report
          path: ui_report.xml
          retention-days: 7
          if-no-files-found: warn 

  api_tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set RUN_TS (timestamp)
        run: |
          echo "RUN_TS=$(TZ=Asia/Seoul date +'%Y%m%d_%H%M%S')" >> $GITHUB_ENV
          echo "BRANCH_NAME=${{ github.ref_name }}" >> $GITHUB_ENV

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install Dependencies
        run: |
          python -m venv venv
          venv/bin/python -m pip install -r requirements.txt allure-pytest

      - name: Install Allure CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y wget unzip
          wget https://github.com/allure-framework/allure2/releases/download/2.32.2/allure-2.32.2.tgz
          tar -zxvf allure-2.32.2.tgz
          sudo mv allure-2.32.2 /opt/allure
          sudo ln -s /opt/allure/bin/allure /usr/bin/allure
          allure --version

      - name: Set API Key Environment Variable
        run: echo "TMDB_API_KEY=${{ secrets.TMDB_API_KEY }}" >> $GITHUB_ENV

      - name: Run API Tests
        run: |
          rm -rf allure-results-api || true
          mkdir -p allure-results-api
          venv/bin/python -m pytest src/tests/api \
            --alluredir=allure-results-api \
            --junitxml=api_report.xml \
            --capture=tee-sys -v \
            --maxfail=100 --disable-warnings --tb=short
        continue-on-error: true

      - name: Upload API Allure Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-results-api
          path: allure-results-api
          retention-days: 7

      - name: Upload API Test Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: api-test-report
          path: api_report.xml
          retention-days: 7
  
  performance_tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Install JMeter
        run: |
            wget https://archive.apache.org/dist/jmeter/binaries/apache-jmeter-5.6.3.tgz
            tar -xzf apache-jmeter-5.6.3.tgz

      - name: Run Performance Test
        env:
          TMDB_API_KEY: ${{ secrets.TMDB_API_KEY }}
        run: |
            apache-jmeter-5.6.3/bin/jmeter -n \
              -t src/tests/performance/tmdb_load_test.jmx \
              -l performance-result.jtl \
              -e -o performance-report/
          

      - name: Upload Performance Test Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: performance-report
          path: performance-report/
          retention-days: 7

  # ==========================================
  # Allure Report ë°°í¬ (GitHub Pages)
  # ==========================================
  deploy:
    needs: [ui_tests, api_tests, performance_tests]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - uses: actions/checkout@v4

      - name: Set Branch Name
        run: |
          echo "BRANCH_NAME=${{ github.ref_name }}" >> $GITHUB_ENV
          # ë¸Œëžœì¹˜ ì´ë¦„ì„ ê²½ë¡œë¡œ ì‚¬ìš© (ìŠ¬ëž˜ì‹œë¥¼ ëŒ€ì‹œë¡œ ë³€í™˜)
          SAFE_BRANCH=$(echo "${{ github.ref_name }}" | sed 's/\//-/g')
          echo "SAFE_BRANCH=$SAFE_BRANCH" >> $GITHUB_ENV

      - name: Download UI Allure Results
        uses: actions/download-artifact@v4
        with:
          name: allure-results-ui
          path: allure-results-ui
        continue-on-error: true

      - name: Download API Allure Results
        uses: actions/download-artifact@v4
        with:
          name: allure-results-api
          path: allure-results-api
        continue-on-error: true

      - name: Merge Allure Results
        run: |
          mkdir -p allure-results
          cp -r allure-results-ui/* allure-results/ 2>/dev/null || true
          cp -r allure-results-api/* allure-results/ 2>/dev/null || true

      - name: Install Allure CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y wget
          wget https://github.com/allure-framework/allure2/releases/download/2.32.2/allure-2.32.2.tgz
          tar -zxvf allure-2.32.2.tgz
          sudo mv allure-2.32.2 /opt/allure
          sudo ln -s /opt/allure/bin/allure /usr/bin/allure

      - name: Generate Allure Report
        run: |
          # ë¸Œëžœì¹˜ë³„ ê²½ë¡œì— ë¦¬í¬íŠ¸ ìƒì„±
          allure generate allure-results -o allure-report/${{ env.SAFE_BRANCH }} --clean

      - name: Set Last Updated Time
        run: echo "LAST_UPDATED=$(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_ENV


      # ALLURE INDEX PAGE ìƒì„±
      - name: Create Index Page
        run: |
          cat > allure-report/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="ko">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>QATEST - Test Reports</title>
              <style>
                  * { margin: 0; padding: 0; box-sizing: border-box; }
                  body {
                      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
                      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                      min-height: 100vh;
                      display: flex;
                      justify-content: center;
                      align-items: center;
                      padding: 20px;
                  }
                  .container {
                      background: white;
                      border-radius: 16px;
                      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                      padding: 40px;
                      max-width: 800px;
                      width: 100%;
                  }
                  h1 {
                      color: #333;
                      margin-bottom: 10px;
                      font-size: 2.5em;
                  }
                  .subtitle {
                      color: #666;
                      margin-bottom: 40px;
                      font-size: 1.1em;
                  }
                  .branch-list {
                      list-style: none;
                  }
                  .branch-item {
                      margin-bottom: 15px;
                  }
                  .branch-link {
                      display: flex;
                      align-items: center;
                      padding: 20px;
                      background: #f8f9fa;
                      border-radius: 12px;
                      text-decoration: none;
                      color: #333;
                      transition: all 0.3s ease;
                      border: 2px solid transparent;
                  }
                  .branch-link:hover {
                      background: #667eea;
                      color: white;
                      transform: translateX(10px);
                      border-color: #667eea;
                  }
                  .branch-icon {
                      font-size: 24px;
                      margin-right: 15px;
                  }
                  .branch-name {
                      font-size: 1.2em;
                      font-weight: 600;
                  }
                  .current {
                      background: #e7f3ff;
                      border-color: #667eea;
                  }
                  .footer {
                      margin-top: 40px;
                      text-align: center;
                      color: #666;
                      font-size: 0.9em;
                  }
              </style>
          </head>
          <body>
              <div class="container">
                  <h1>ðŸ§ª QATEST</h1>
                  <p class="subtitle">Test Automation Reports</p>

                  <ul class="branch-list">
                      <li class="branch-item">
                          <a href="./main/" class="branch-link current">
                              <span class="branch-icon">ðŸŒ¿</span>
                              <span class="branch-name">main</span>
                          </a>
                      </li>
                      <li class="branch-item">
                          <a href="./develop/" class="branch-link">
                              <span class="branch-icon">ðŸ”§</span>
                              <span class="branch-name">develop</span>
                          </a>
                      </li>
                      <!-- Add more branches as needed -->
                  </ul>

                  <div class="footer">
                      <p>Last updated: ${{ env.LAST_UPDATED }}</p>
                      <p>Branch: ${{ env.BRANCH_NAME }} | Run: <a href="https://github.com/yoplekiller/QATEST/actions/runs/${{ github.run_id }}" target="_blank">#${{ github.run_id }}</a></p>
                  </div>
              </div>
          </body>
          </html>
          EOF

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./allure-report
          publish_branch: gh-pages
          keep_files: true
          destination_dir: .

  # ==========================================
  # Slack ì•Œë¦¼
  # ==========================================
  notify_slack:
    needs: [ui_tests, api_tests, performance_tests, deploy]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install requests
        run: pip install requests

      - name: Download UI Test Report
        uses: actions/download-artifact@v4
        with:
          name: ui-test-report
          path: .
        continue-on-error: true

      - name: Download API Test Report
        uses: actions/download-artifact@v4
        with:
          name: api-test-report
          path: .
        continue-on-error: true

      - name: Send Slack Notification
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.QA_SLACK_WEBHOOK_URL }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          BRANCH_NAME: ${{ github.ref_name }}
        run: |
          python utils/send_slack_result.py
